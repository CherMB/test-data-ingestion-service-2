{
    "definition": {
        "id": "successful-deployments-compare",
        "title": "Successful deployments",
        "sub_title": "Comparison",
        "breadCrumbTitle": "{{.orgName}}",
        "post_process_function_name": "deployments component comparison",
        "column_details": {
            "column1": "Name",
            "column2": "Count"
        },
        "header_field": "totalValue",
        "compare_common_section_details": {}
    },
    "queries": {
        "deploymentsChart": {
            "alias": "deploy_data",
            "query": {
                "_source": false,
                "size": 0,
                "query": {
                    "bool": {
                        "filter": [
                            {
                                "range": {
                                    "status_timestamp": {
                                        "gte": "{{.startDate}}",
                                        "lte": "{{.endDate}}",
                                        "format": "yyyy-MM-dd HH:mm:ss",
                                        "time_zone": "{{.timeZone}}"
                                    }
                                }
                            },
                            {
                                "term": {
                                    "org_id": "{{.orgId}}"
                                }
                            },
                            {
                                "term": {
                                    "step_kind": "deploy"
                                }
                            },
                            {
                                "bool": {
                                    "should": [
                                        {
                                            "term": {
                                                "status": "SUCCEEDED"
                                            }
                                        }
                                    ]
                                }
                            },
                            {
                                "bool": {
                                    "must_not": [
                                        {
                                            "term": {
                                                "target_env": ""
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                },
                "aggs": {
                    "deployments_component_comparison": {
                        "terms": {
                            "field": "component_id",
                            "size": 10000
                        },
                        "aggs": {
                            "deploys": {
                                "scripted_metric": {
                                    "init_script": "state.data_map=[:];",
                                    "map_script": "def map = state.data_map;def key = doc.target_env.value + '_' + doc.run_id.value + '_' + doc.job_id.value + '_' + doc.step_id.value + '_' + doc.status.value;def v = ['automation_id':doc.automation_id.value,'component_id':doc.component_id.value, 'org_id':doc.org_id.value,'component_name':doc.component_name.value, 'target_env':doc.target_env.value, 'step_kind':doc.step_kind.value,'run_number':doc.run_number.value,'workflow_name':doc.workflow_name.value, 'run_id': doc.run_id.value, 'status': doc.status.value,'duration':doc.duration.value,'status_timestamp':doc.status_timestamp.value,'workflow_name':doc.workflow_name.value,'org_name':doc.org_name.value];map.put(key, v);",
                                    "combine_script": "return state.data_map;",
                                    "reduce_script": "def resultMap = new HashMap(), totalCount = 0;for (response in states) {if (response != null) {for (key in response.keySet()) {resultMap.put(key, response.get(key));}}}for (key in resultMap.keySet()) {totalCount++;}return totalCount;"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}