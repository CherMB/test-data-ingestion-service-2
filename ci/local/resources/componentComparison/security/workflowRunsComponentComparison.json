{
  "definition": {
    "id": "security-workflow-runs-compare",
    "title": "Successful workflow runs",
    "sub_title": "Comparison",
    "breadCrumbTitle": "{{.orgName}}",
    "post_process_function_name": "security workflow runs component comparison",
    "column_details": {
      "column1": "Organization name",
      "column2": "Count / Status"
    },
    "header_field": "totalValue",
    "compare_common_section_details": {
      "type": 2,
      "show_legends": false,
      "is_component_compare": true,
      "orientation": 0,
      "append_unit": " ",
      "tooltip_formatter": 1,
      "color_scheme": [
        {
          "color0": "#8BA9B8",
          "color1": "#5D7689"
        },
        {
          "color0": "#FFDAA5",
          "color1": "#FF8509"
        }
      ],
      "light_color_scheme": [
        {
          "color0": "#B2CDDF",
          "color1": "#7297AE"
        },
        {
          "color0": "#FFDAA5",
          "color1": "#FF9529"
        }
      ]
    }
  },
  "queries": {
    "runsStatusChart": {
      "alias": "automation_run_status,scan_results",
      "query": {
        "_source": false,
        "size": 0,
        "query": {
          "bool": {
            "should": [
              {
                "bool": {
                  "must": [
                    {
                      "term": {
                        "_index": "automation_run_status"
                      }
                    },
                    {
                      "range": {
                        "timestamp": {
                          "gte": "{{.startDate}}",
                          "lte": "{{.endDate}}",
                          "format": "yyyy-MM-dd HH:mm:ss",
                          "time_zone": "{{.timeZone}}"
                        }
                      }
                    },
                    {
                      "term": {
                        "org_id": "{{.orgId}}"
                      }
                    },
                    {
                      "term": {
                        "job_id": ""
                      }
                    },
                    {
                      "term": {
                        "step_id": ""
                      }
                    },
                    {
                      "bool": {
                        "should": [
                          {
                            "term": {
                              "status": "SUCCEEDED"
                            }
                          },
                          {
                            "term": {
                              "status": "FAILED"
                            }
                          },
                          {
                            "term": {
                              "status": "TIMED_OUT"
                            }
                          },
                          {
                            "term": {
                              "status": "ABORTED"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "bool": {
                  "must": [
                    {
                      "term": {
                        "_index": "scan_results"
                      }
                    },
                    {
                      "term": {
                        "org_id": "{{.orgId}}"
                      }
                    },
                    {
                      "range": {
                        "timestamp": {
                          "gte": "{{.startDate}}",
                          "lte": "{{.endDate}}",
                          "format": "yyyy-MM-dd HH:mm:ss",
                          "time_zone": "{{.timeZone}}"
                        }
                      }
                    }
                  ]
                }
              }
            ]
          }
        },
        "aggs": {
          "workflow_runs_component_comparison": {
            "terms": {
              "field": "component_id",
              "size": 10000
            },
            "aggs": {
              "run_status": {
                "scripted_metric": {
                  "init_script": "state.data_map=[:];state.scanRunIds=new HashSet();",
                  "map_script": "def map = state.data_map;def scanRunIdsSet=state.scanRunIds;if(doc.containsKey('scanner_type')){scanRunIdsSet.add(doc.run_id.value);}else{def key = doc.org_id+'_'+doc.automation_id.value + '_' + doc.run_id.value + '_' + doc.status.value;def v = ['automation_id': doc.automation_id.value, 'run_id': doc.run_id.value];map.put(key, v);}",
                  "combine_script": "def stateMap =new HashMap();stateMap.put('scanRunIds',state.scanRunIds);stateMap.put('data_map',state.data_map);return stateMap;",
                  "reduce_script": "def tmpMap=[:];def totalCount=0;def withScans=0;def scanRunIds=new HashSet();def autoRunIds=new HashSet();for(a in states){if(a!=null){for(i in a.keySet()){if(i=='scanRunIds'){scanRunIds.addAll(a.get(i));}else if(i=='data_map'){def dataMap=a.get(i);for(k in dataMap.keySet()){def runData=dataMap.get(k);tmpMap.put(k,runData);}}}}}for(key in tmpMap.keySet()){def mapRecord=tmpMap.get(key);autoRunIds.add(mapRecord.run_id);}for(String k:autoRunIds){if(scanRunIds.contains(k)){withScans++;}}totalCount=autoRunIds.size();def totalRecord=['key':'Total','value':totalCount];def withScanners=['title':'With Scanners','value':withScans];def withoutScanners=['title':'Without Scanners','value':totalCount-withScans];def infoList=new ArrayList();infoList.add(withScanners);infoList.add(withoutScanners);def resultMap=new HashMap();def dataMap=new HashMap();resultMap.put('Total',totalRecord);dataMap.put('info',infoList);resultMap.put('chartData',dataMap);return resultMap;"
                }
              }
            }
          }
        }
      }
    }
  }
}