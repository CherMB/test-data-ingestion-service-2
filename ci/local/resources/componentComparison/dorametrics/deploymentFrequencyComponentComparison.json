{
    "definition": {
        "id": "deployment-frequency-compare",
        "title": "Deployment frequency",
        "sub_title": "Comparison",
        "breadCrumbTitle": "{{.orgName}}",
        "post_process_function_name": "deployment frequency component comparison",
        "column_details": {
            "column1": "Name",
            "column2": "Average per day"
        },
        "header_field": "totalValue",
        "compare_common_section_details": {
            "append_unit": " ",
            "tooltip_formatter": 1
        }    
    },
    "queries":{
        "deploymentFrequencyHeader": {
            "alias": "deploy_data",
            "query": {
                "size": 0,
                "query": {
                    "bool": {
                        "filter": [
                            {
                                "range": {
                                    "status_timestamp": {
                                        "gte": "{{.startDate}}",
                                        "lte": "{{.endDate}}",
                                        "format": "yyyy-MM-dd HH:mm:ss",
                                        "time_zone":"{{.timeZone}}"
                                    }
                                }
                            },
                            {
                                "term": {
                                    "org_id": "{{.orgId}}"
                                }
                            },
                            {
                                "term": {
                                    "status": "SUCCEEDED"
                                }
                            },
                            {
                                "term": {
                                    "target_env": "{{.targetEnv}}"
                                }
                            }
                        ]
                    }
                },
                "aggs": {
                    "deployment_frequency_component_comparison": {
                        "terms": {
                          "field": "component_id",
                          "size": 10000
                        },
                        "aggs": {
                            "deploy_data": {
                                "scripted_metric": {
                                    "combine_script": "return state.data_map;",
                                    "init_script": "state.data_map=[:];",
                                    "map_script": "def map = state.data_map;def key = doc.component_id.value + '_' + doc.run_id.value + '_' + doc.job_id.value + '_' + doc.step_id.value + '_' + doc.target_env.value + '_' + doc.status.value;def v = ['run_id': doc.run_id.value, 'job_id': doc.job_id.value, 'step_id': doc.step_id.value, 'target_env': doc.target_env.value, 'step_kind': doc.step_kind.value, 'start_time': doc.start_time.value, 'completed_time': doc.completed_time.value, 'status_timestamp': doc.status_timestamp.value, 'status': doc.status.value, 'component_id': doc.component_id.value];map.put(key, v);",
                                    "reduce_script": "def allDataMap = [: ], resultMap = new HashMap(), resultArray = [];for (response in states) {if (response != null) {for (key in response.keySet()) {allDataMap.put(key, response.get(key));}}}def size = ''+ allDataMap.size(),startDate = {{.startDateInMillis}}L, endDate = {{.endDateInMillis}}L;def deployments = Double.parseDouble(size);def differenceInDays = Math.round((endDate - startDate) / 86400000.00);resultMap.put('deployments',deployments);resultMap.put('differenceDays',differenceInDays);resultMap.put('average',Math.round(deployments/differenceInDays * 100)/100.0); return resultMap;"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}