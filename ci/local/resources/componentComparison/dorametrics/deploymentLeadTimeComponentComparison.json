{
    "definition": {
        "id": "deployment-lead-time-compare",
        "title": "Deployment lead time",
        "sub_title": "Comparison",
        "breadCrumbTitle": "{{.orgName}}",
        "post_process_function_name": "deployment lead time component comparison",
        "column_details": {
            "column1": "Name",
            "column2": "Average duration"
        },
        "header_field": "valueInMillis",
        "compare_common_section_details": {
            "append_unit": " ",
            "tooltip_formatter": 2
        }    
    },
    "queries":{
        "deploymentLeadTimeHeader": {
            "alias": "deploy_data",
            "query": {
                "size": 0,
                "query": {
                    "bool": {
                        "filter": [
                            {
                                "range": {
                                    "status_timestamp": {
                                        "gte": "{{.startDate}}",
                                        "lte": "{{.endDate}}",
                                        "format": "yyyy-MM-dd HH:mm:ss",
                                        "time_zone":"{{.timeZone}}"
                                    }
                                }
                            },
                            {
                                "term": {
                                    "org_id": "{{.orgId}}"
                                }
                            },
                            {
                                "term": {
                                    "status": "SUCCEEDED"
                                }
                            },
                            {
                                "term": {
                                    "target_env": "{{.targetEnv}}"
                                }
                            }
                        ]
                    }
                },
                "aggs": {
                    "deployment_lead_time_component_comparison": {
                        "terms": {
                          "field": "component_id",
                          "size": 10000
                        },
                        "aggs": {
                            "deploy_data": {
                                "scripted_metric": {
                                    "combine_script": "return state.data_map;",
                                    "init_script": "state.data_map=[:];",
                                    "map_script": "def map = state.data_map,runStartTime=0;def key = doc.component_id.value + '_' + doc.run_id.value + '_' + doc.job_id.value + '_' + doc.step_id.value + '_' + doc.target_env.value + '_' + doc.status.value;def v = ['run_id': doc.run_id.value, 'job_id': doc.job_id.value, 'step_id': doc.step_id.value, 'target_env': doc.target_env.value, 'step_kind': doc.step_kind.value, 'start_time': doc.start_time.value, 'completed_time': doc.completed_time.value, 'status_timestamp': doc.status_timestamp.value, 'status': doc.status.value, 'component_id': doc.component_id.value,'automation_id':doc.automation_id.value,'duration':doc.duration.value];if (doc['run_start_time'].size() != 0) {runStartTime=doc.run_start_time.value;}v['run_start_time']=runStartTime;map.put(key, v);",
                                    "reduce_script": "def allDataMap = [: ], resultMap = new HashMap();for (response in states) {if (response != null) {for (key in response.keySet()) {def record = response.get(key);if (record.run_start_time > 0) {record['totalDuration'] = record.status_timestamp.getMillis() - record.run_start_time;} else if (record.duration > 0) {record['totalDuration'] = record.duration;}allDataMap.put(key, record);}}}def size = '' + allDataMap.size(), totalDuration = 0.0;def deployments = Double.parseDouble(size);for (key in allDataMap.keySet()) {def record = allDataMap.get(key);if (record.run_start_time > 0) {totalDuration += record.status_timestamp.getMillis() - record.run_start_time;} else if (record.duration > 0) {totalDuration += record.duration;}}resultMap.put('deployments', deployments);resultMap.put('totalDuration', totalDuration);resultMap.put('average', Math.round(totalDuration / deployments * 100) / 100.0);return resultMap;"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}