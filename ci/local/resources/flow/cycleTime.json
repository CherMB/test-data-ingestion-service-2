{
    "widget": {
        "id": "f7",
        "title": "Cycle time",
        "description": "",
        "enable_components_compare": true,
        "components_compare_id": "cycle-time-compare",
        "content": [
            {
                "header": [
                    {
                        "title": "Average work item time to completion, by type",
                        "description": "Average work item time to completion, by type",
                        "drill_down": {
                            "report_id": "flowMetrics-cycleTime",
                            "report_type": "flowItemType",
                            "report_title": "Cycle time"
                        },
                        "post_process_function_name": "cycle time",
                        "spec_key": "flowCycleTimeHeaderSpec"
                    }
                ],
                "section": [
                    {
                        "type": 1,
                        "show_legends": true,
                        "color_scheme": [
                            {
                                "color0": "#E19090",
                                "color1": "#DE3838"
                            },
                            {
                                "color0": "#62B0FF",
                                "color1": "#1C67FF"
                            },
                            {
                                "color0": "#E2C2A4",
                                "color1": "#E78730"
                            },
                            {
                                "color0": "#9FB6C1",
                                "color1": "#577688"
                            }
                        ],
                        "light_color_scheme": [
                            {
                                "color0": "#FF9E9C",
                                "color1": "#DE4643"
                            },
                            {
                                "color0": "#38B3FB",
                                "color1": "#047ED0"
                            },
                            {
                                "color0": "#FFD3AA",
                                "color1": "#E8A263"
                            },
                            {
                                "color0": "#AFBFC6",
                                "color1": "#7692A3"
                            }
                        ],
                        "post_process_function_name": "cycle time",
                        "spec_key": "flowCycleTimeChartSpec",
                        "enable_post_transformation_processing": true,
                        "drill_down": {
                            "report_id": "flowMetrics-cycleTime",
                            "report_type": "flowItemType",
                            "report_title": "Cycle time"
                        }
                    }
                ]
            }
        ]
    },
    "queries": {
        "flowCycleTimeHeader": {
            "alias": "flow_metrics",
            "query": {
                "size": 0,
                "query": {
                    "bool": {
                        "filter": [
                            {
                                "range": {
                                    "completed_at": {
                                        "gte": "{{.startDate}}",
                                        "lte": "{{.endDate}}",
                                        "format": "yyyy-MM-dd HH:mm:ss",
                                        "time_zone":"{{.timeZone}}"
                                    }
                                }
                            },
                            {
                                "term": {
                                    "org_id": "{{.orgId}}"
                                }
                            },
                            {
                                "term": {
                                    "deleted": "false"
                                }
                            }
                        ]
                    }
                },
                "aggs": {
                    "flow_cycle_time_count": {
                        "scripted_metric": {
                            "init_script": "state.statusMap = [:];",
                            "map_script": "def map=state.statusMap;def key=doc.automation_id.value+'_'+doc.component_id.value+'_'+doc.flow_item.value+'_'+doc.issue_key.value+'_'+doc.run_id.value+'_'+doc.org_id.value+'_'+doc.updated_at.getValue().toEpochSecond()*1000;def v=['updatedAt':doc['updated_at'].getValue().toEpochSecond()*1000,'automation_id':doc.automation_id.value,'component_id':doc.component_id.value,'flow_item':doc.flow_item.value,'run_id':doc.run_id.value,'org_id':doc.org_id.value,'issue_key':doc.issue_key.value,'flow_time':doc.flow_time.value];map.put(key,v);",
                            "combine_script": "return state.statusMap;",
                            "reduce_script": "def statusMap=new HashMap();def metricsMap=new HashMap();def outputMap=new HashMap();def totalFlowTime=0;def count=0;def averageFlowTime=0;for(a in states){if(a!=null){for(i in a.keySet()){def record=a.get(i);def key=record.issue_key;if(statusMap.containsKey(key)){def lastRecord=statusMap.get(key);if(lastRecord.updatedAt<record.updatedAt){statusMap.put(key,record);}}else{statusMap.put(key,record);}}}}for(type in statusMap.keySet()){def flowTime=statusMap.get(type).flow_time;totalFlowTime=totalFlowTime+flowTime;count++;}if(count>0){averageFlowTime=totalFlowTime/count}def n=averageFlowTime/1000;def day=n/(24*3600);n=n%(24*3600);def hour=n/3600;n%=3600;def minutes=n/60;n%=60;def seconds=n;def result='';if(day>0){result=result+day+'d ';}if(hour>0){if(result.length()>0){result=' '+result+hour+'h ';}else{result=result+hour+'h ';}}if(minutes>0){if(result.length()>0){result=' '+result+minutes+'m';}else{result=result+minutes+'m';}}outputMap.put('value',result);outputMap.put('valueInMillis',averageFlowTime);return outputMap;"
                        }
                    }
                }
            }
        },
        "flowCycleTimeChart": {
            "alias": "flow_metrics",
            "query": {
                "size": 0,
                "query": {
                    "bool": {
                        "filter": [
                            {
                                "range": {
                                    "completed_at": {
                                        "gte": "{{.startDate}}",
                                        "lte": "{{.endDate}}",
                                        "format": "yyyy-MM-dd HH:mm:ss",
                                        "time_zone":"{{.timeZone}}"
                                    }
                                }
                            },
                            {
                                "term": {
                                    "org_id": "{{.orgId}}"
                                }
                            },
                            {
                                "term": {
                                    "deleted": "false"
                                }
                            }
                        ]
                    }
                },
                "aggs": {
                    "flow_cycle_time_buckets": {
                        "date_histogram": {
                            "field": "completed_at",
                            "calendar_interval": "{{.aggrBy}}",
                            "min_doc_count": 0,
                            "format": "yyyy-MM-dd",
                            "time_zone":"{{.timeZone}}",
                            "extended_bounds": {
                                "min": "{{.dateHistogramMin}}",
                                "max": "{{.dateHistogramMax}}"
                            }
                        },
                        "aggs": {
                            "flow_cycle_time_count": {
                                "scripted_metric": {
                                    "init_script": "state.statusMap = [:];",
                                    "map_script": "def map=state.statusMap;def key=doc.automation_id.value+'_'+doc.component_id.value+'_'+doc.flow_item.value+'_'+doc.issue_key.value+'_'+doc.run_id.value+'_'+doc.org_id.value+'_'+doc.updated_at.getValue().toEpochSecond()*1000;def v=['updatedAt':doc['updated_at'].getValue().toEpochSecond()*1000,'automation_id':doc.automation_id.value,'component_id':doc.component_id.value,'flow_item':doc.flow_item.value,'run_id':doc.run_id.value,'org_id':doc.org_id.value,'issue_key':doc.issue_key.value,'flow_time':doc.flow_time.value];map.put(key,v);",
                                    "combine_script": "return state.statusMap;",
                                    "reduce_script": "def statusMap=new HashMap();def countMap=new HashMap();def flowTimeMap=new HashMap();def resultMap=new HashMap();def totalCount=0;countMap.put('FEATURE',0);countMap.put('DEFECT',0);countMap.put('RISK',0);countMap.put('TECH_DEBT',0);for(a in states){if(a!=null){for(i in a.keySet()){def record=a.get(i);def key=record.issue_key;if(statusMap.containsKey(key)){def lastRecord=statusMap.get(key);if(lastRecord.updatedAt<record.updatedAt){statusMap.put(key,record);}}else{statusMap.put(key,record);}}}}for(type in statusMap.keySet()){def countRecordType=statusMap.get(type).flow_item;if(countMap.containsKey(countRecordType)){def count=countMap.get(countRecordType);countMap.put(countRecordType,count+1);}else{countMap.put(countRecordType,1);}}for(type in statusMap.keySet()){def flowItemType=statusMap.get(type).flow_item;if(flowTimeMap.containsKey(flowItemType)){def totalFlowTime=flowTimeMap.get(flowItemType);def flowTime=statusMap.get(type).flow_time;flowTimeMap.put(flowItemType,totalFlowTime+flowTime);}else{def flowTime=statusMap.get(type).flow_time;flowTimeMap.put(flowItemType,flowTime);}totalCount++;}for(type in countMap.keySet()){def count=countMap.get(type);if(count>0){long cycleTimeMs=(flowTimeMap.get(type)/count);long cycleTimeHrs=cycleTimeMs/(1000*60*60);resultMap.put(type,cycleTimeMs);}else{resultMap.put(type,0);}}return resultMap;"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}