{
    "widget": {
        "id": "f6",
        "title": "Velocity",
        "description": "",
        "enable_components_compare": true,
        "components_compare_id": "velocity-compare",
        "content": [
            {
                "header": [
                    {
                        "title": "Number of completed work items, by type",
                        "description": "Number of completed work items, by type",
                        "drill_down": {
                            "report_id": "flowMetrics-velocity",
                            "report_type": "flowItemType",
                            "report_title": "Velocity"
                        },
                        "post_process_function_name": "velocity",
                        "spec_key": "flowVelocityHeaderSpec"
                    }
                ],
                "section": [
                    {
                        "type": 1,
                        "show_legends": true,
                        "color_scheme": [
                            {
                                "color0": "#E19090",
                                "color1": "#DE3838"
                            },
                            {
                                "color0": "#62B0FF",
                                "color1": "#1C67FF"
                            },
                            {
                                "color0": "#E2C2A4",
                                "color1": "#E78730"
                            },
                            {
                                "color0": "#9FB6C1",
                                "color1": "#577688"
                            }
                        ],
                        "light_color_scheme": [
                            {
                                "color0": "#FF9E9C",
                                "color1": "#DE4643"
                            },
                            {
                                "color0": "#38B3FB",
                                "color1": "#047ED0"
                            },
                            {
                                "color0": "#FFD3AA",
                                "color1": "#E8A263"
                            },
                            {
                                "color0": "#AFBFC6",
                                "color1": "#7692A3"
                            }
                        ],
                        "post_process_function_name": "velocity",
                        "spec_key": "flowVelocityChartSpec",
                        "enable_post_transformation_processing": true,
                        "drill_down": {
                            "report_id": "flowMetrics-velocity",
                            "report_type": "flowItemType",
                            "report_title": "Velocity"
                        }
                    }
                ]
            }
        ]
    },
    "queries": {
        "flowVelocityHeader": {
            "alias": "flow_metrics",
            "query": {
                "size": 0,
                "query": {
                    "bool": {
                        "filter": [
                            {
                                "range": {
                                    "completed_at": {
                                        "gte": "{{.startDate}}",
                                        "lte": "{{.endDate}}",
                                        "format": "yyyy-MM-dd HH:mm:ss",
                                        "time_zone":"{{.timeZone}}"
                                    }
                                }
                            },
                            {
                                "term": {
                                    "org_id": "{{.orgId}}"
                                }
                            },
                            {
                                "term": {
                                    "deleted": "false"
                                }
                            }
                        ]
                    }
                },
                "aggs": {
                    "velocity": {
                        "cardinality": {
                            "script": "[doc['issue_key'].value]"
                        }
                    }
                }
            }
        },
        "flowVelocityChart": {
            "alias": "flow_metrics",
            "query": {
                "size": 0,
                "query": {
                    "bool": {
                        "filter": [
                            {
                                "range": {
                                    "completed_at": {
                                        "gte": "{{.startDate}}",
                                        "lte": "{{.endDate}}",
                                        "format": "yyyy-MM-dd HH:mm:ss",
                                        "time_zone":"{{.timeZone}}"
                                    }
                                }
                            },
                            {
                                "term": {
                                    "org_id": "{{.orgId}}"
                                }
                            },
                            {
                                "term": {
                                    "deleted": "false"
                                }
                            }
                        ]
                    }
                },
                "aggs": {
                    "flow_velocity_buckets": {
                        "date_histogram": {
                            "field": "completed_at",
                            "calendar_interval": "{{.aggrBy}}",
                            "min_doc_count": 0,
                            "format": "yyyy-MM-dd",
                            "time_zone":"{{.timeZone}}",
                            "extended_bounds": {
                                "min": "{{.dateHistogramMin}}",
                                "max": "{{.dateHistogramMax}}"
                            }
                        },
                        "aggs": {
                            "flow_velocity_count": {
                                "scripted_metric": {
                                    "init_script": "state.statusMap = [:];",
                                    "map_script": "def map=state.statusMap;def key=doc.automation_id.value+'_'+doc.component_id.value+'_'+doc.flow_item.value+'_'+doc.issue_key.value+'_'+doc.run_id.value+'_'+doc.org_id.value;def v=['updatedAt':doc['updated_at'].getValue().toEpochSecond()*1000,'automation_id':doc.automation_id.value,'component_id':doc.component_id.value,'flow_item':doc.flow_item.value,'run_id':doc.run_id.value,'org_id':doc.org_id.value,'issue_key':doc.issue_key.value];map.put(key,v);",
                                    "combine_script": "return state.statusMap;",
                                    "reduce_script": "def statusMap=new HashMap();def countMap=new HashMap();countMap.put('FEATURE',0);countMap.put('DEFECT',0);countMap.put('RISK',0);countMap.put('TECH_DEBT',0);for(a in states){if(a!=null){for(i in a.keySet()){def record=a.get(i);def key=record.issue_key;if(statusMap.containsKey(key)){def lastRecord=statusMap.get(key);if(lastRecord.updatedAt<record.updatedAt){statusMap.put(key,record);}}else{statusMap.put(key,record);}}}}for(type in statusMap.keySet()){def countRecordType=statusMap.get(type).flow_item;if(countMap.containsKey(countRecordType)){def count=countMap.get(countRecordType);countMap.put(countRecordType,count+1);}else{countMap.put(countRecordType,1);}}return countMap;"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}